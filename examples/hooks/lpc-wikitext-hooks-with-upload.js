import "dotenv/config"
import process from "node:process"
import {Glog, Time} from "@gesslar/toolkit"
import Wikid from "@gesslar/wikid"

export class Format {
  #BASE_URL
  #BOT_USERNAME
  #BOT_PASSWORD

  #glog

  constructor() {
    this.#glog = new Glog()
  }

  /**
   * Setup the current hooks and set some initial values.
   *
   * @async
   */
  setup = async() => {
    try {
      this.debug = log.newDebug()

      const {BASE_URL,BOT_USERNAME,BOT_PASSWORD} = process.env
      this.#BASE_URL = BASE_URL
      this.#BOT_USERNAME = BOT_USERNAME
      this.#BOT_PASSWORD = BOT_PASSWORD
    } catch(error) {
      this.#glog.error(`Error setting up hooks:`, error)
    }
  }

  /**
     * Processes a module at the end, converting the syntax highlighting from
     * markdown to wikitext.
     *
     * Additionally, uploads the data to a MediaWiki site.
     *
     * @async
     * @param {object} module Options object.
     * @param {string} module.moduleName The name of the module being processed
     * @param {string} module.moduleContent The output generated by the formatt
     * @param {number?} [module.count] The number of times we've done this.
     * @returns {Promise<string>} The altered text.
     */
  after$finalize = async(ctx, current) => {
    debugger
    /*
    const {moduleName,moduleContent} = module
    const count = module.count ?? 0

    const {#BASE_URL: BASE_URL, #BOT_USERNAME: BOT_USERNAME, #BOT_PASSWORD: BOT_PASSWORD} = this
    const bot = new MediaWikiUploader()
    if(!bot)
      throw new Error("MediaWiki bot not instantiated.")

    const info = (...arg) => this.log.info(...arg)

    if(count > 0)
      info(`Retrying \`${moduleName}\` #${count}...`)

    const wikitext = moduleContent
      .replace(
        /```c\n([\s\S]+?)```/g,
        '<syntaxhighlight lang="c">\n$1</syntaxhighlight>\n',
      ) + "\n{{sefun}}\n"

    try {
      const loginResult = await bot.login({
        baseUrl: BASE_URL,
        botUsername: BOT_USERNAME,
        botPassword: BOT_PASSWORD
      })

      if(loginResult.status === "error")
        throw loginResult.error

      const request = {
        token: loginResult.token,
        title: moduleName,
        content: wikitext
      }

      const editResult = await bot.createOrEditPage(request)

      if(editResult.status === "error") {
        const data = JSON.parse(editResult.error.message)
        const secs = 10 + (count * 2)

        if(data?.error?.code) {
          if(data.error.code === "ratelimited") {
            this.log.warn(`Rate limited for \`${moduleName}\`. Trying again in ${secs} seconds.`)

            await timeoutPromise(secs*1_000)
            module.count = count+1

            return this.end(module)
          } else {
            throw new Error(`Error uploading \`${moduleName}\`: ${data.error.info}`)
          }
        }
      }

      // console.log(editResult)
      // console.log(editResult.result)
      const {title, oldrevid} = editResult.result
      const sanitizedUrl =
        `${BASE_URL}/index.php?title=${encodeURIComponent(title)}`
      if(oldrevid !== undefined) {
        if(oldrevid === 0) {
          this.log.info(`Page created successfully: '${sanitizedUrl}'`)
        } else {
          this.log.info(`Page edited successfully: '${sanitizedUrl}'`)
        }
      } else {
        this.log.info(`No change was made to page '${sanitizedUrl}'`)
      }
    } catch(error) {
      this.log.error(`Error creating/editing page: ${error.message}`)
    }

    return wikitext
    */
  }
}
